<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ã‚¹ãƒãƒ›æ¨¹é«˜æ¸¬å®šï¼ˆãƒãƒ¼ãƒ«åŸºæº–ï¼‰</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .sensor-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #007bff;
            margin: 10px 0;
            font-variant-numeric: tabular-nums;
        }
        .label {
            font-size: 0.9rem;
            color: #666;
        }
        .input-group {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        input[type="number"] {
            font-size: 1.2rem;
            padding: 8px;
            width: 80px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        button {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: bold;
        }
        /* ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
        #btn-base { background-color: #6c757d; color: white; } /* æ ¹å…ƒï¼šåœ°é¢ã£ã½ã„è‰² */
        #btn-pole { background-color: #e67e22; color: white; } /* ãƒãƒ¼ãƒ«ï¼šç›®ç«‹ã¤è‰² */
        #btn-top { background-color: #28a745; color: white; }  /* æœ¨ã®é ‚ç‚¹ï¼šç·‘ */
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        button:active {
            transform: scale(0.98);
        }
        .result-box {
            background-color: #e8f5e9;
            border: 2px solid #28a745;
            color: #1b5e20;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        .result-value {
            font-size: 2rem;
            font-weight: bold;
        }
        #ios-permission-btn {
            background-color: #007bff;
            color: white;
            display: none; /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º */
        }
        .step-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ddd;
            margin-right: 5px;
        }
        .step-done {
            background-color: #28a745;
        }
    </style>
</head>
<body>

    <h1>ğŸŒ² æ¨¹é«˜æ¸¬å®šï¼ˆãƒãƒ¼ãƒ«å¼ï¼‰</h1>

    <button id="ios-permission-btn" onclick="requestPermission()">ã‚»ãƒ³ã‚µãƒ¼ã®ä½¿ç”¨ã‚’è¨±å¯ã™ã‚‹</button>

    <div class="card">
        <div class="label">ç¾åœ¨ã®ã‚¹ãƒãƒ›å‚¾ãï¼ˆä»°è§’ï¼‰</div>
        <div class="sensor-value" id="current-angle">--Â°</div>
        <div style="font-size:0.8rem; color:#888;">â€»ã‚¹ãƒãƒ›ã‚’ç¸¦ã«æŒã£ã¦å¯¾è±¡ã«å‘ã‘ã¦ãã ã•ã„</div>
    </div>

    <div class="card">
        <div class="input-group">
            <label>ãƒãƒ¼ãƒ«ã®é«˜ã•(m):</label>
            <input type="number" id="pole-height" value="2.0" step="0.1">
        </div>

        <button id="btn-base" onclick="recordAngle(1)">
            <span id="step1" class="step-indicator"></span> â‘  ãƒãƒ¼ãƒ«ã®æ ¹å…ƒ
        </button>
        <div id="val-1" class="label" style="text-align:right; min-height:1.2em;"></div>

        <button id="btn-pole" onclick="recordAngle(2)">
            <span id="step2" class="step-indicator"></span> â‘¡ ãƒãƒ¼ãƒ«ã®ä¸Šç«¯
        </button>
        <div id="val-2" class="label" style="text-align:right; min-height:1.2em;"></div>

        <button id="btn-top" onclick="recordAngle(3)">
            <span id="step3" class="step-indicator"></span> â‘¢ æœ¨ã®é ‚ç‚¹
        </button>
        <div id="val-3" class="label" style="text-align:right; min-height:1.2em;"></div>
    </div>

    <div id="result-area" class="result-box">
        <div>æ¨å®šæ¨¹é«˜</div>
        <div class="result-value"><span id="tree-height">0.0</span> m</div>
        <div style="font-size:0.9rem; margin-top:5px; color:#555;">(å‚è€ƒ) æœ¨ã¾ã§ã®æ°´å¹³è·é›¢: <span id="tree-dist">0.0</span> m</div>
        <button onclick="resetMeasurement()" style="background:#666; margin-top:15px; font-size:0.9rem;">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <script>
        let currentBeta = 0; // ç¾åœ¨ã®ã‚»ãƒ³ã‚µãƒ¼å€¤
        let angle1 = null; // æ ¹å…ƒ
        let angle2 = null; // ãƒãƒ¼ãƒ«ä¸Š
        let angle3 = null; // æœ¨ã®é ‚ç‚¹

        // iOSåˆ¤å®š
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            document.getElementById('ios-permission-btn').style.display = 'block';
        } else {
            // Androidç­‰ã¯ç›´æ¥é–‹å§‹
            window.addEventListener('deviceorientation', handleOrientation);
        }

        function requestPermission() {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        document.getElementById('ios-permission-btn').style.display = 'none';
                        window.addEventListener('deviceorientation', handleOrientation);
                    } else {
                        alert("ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™");
                    }
                })
                .catch(console.error);
        }

        function handleOrientation(event) {
            // betaã¯ã‚¹ãƒãƒ›ã‚’ç«‹ã¦ã‚‹ã¨90ã€å¯ã‹ã›ã‚‹ã¨0ã€æ‰‹å‰ã«å‚¾ã‘ã‚‹ã¨>90ã«ãªã‚‹ã“ã¨ãŒå¤šã„ï¼ˆæ©Ÿç¨®ä¾å­˜ã‚ã‚Šï¼‰
            // ä¸€èˆ¬çš„ãªWebæ¨™æº–: 
            // å‚ç›´(90)ã‹ã‚‰ã€ä»°è§’(è¦‹ä¸Šã’ã‚‹)ã‚’è¨ˆç®—ã—ãŸã„ã€‚
            // è¦‹ä¸Šã’ã‚‹ã¨betaã¯90ã‚ˆã‚Šå°ã•ããªã‚‹ï¼ˆç”»é¢ãŒä¸Šã‚’å‘ããŸã‚ï¼‰
            // ä»°è§’ = 90 - beta ã¨ä»®å®šã—ã¦å®Ÿè£…ã—ã¾ã™ï¼ˆå®Ÿéš›ã®æŒ™å‹•ã«åˆã‚ã›ã¦èª¿æ•´ãŒå¿…è¦ãªå ´åˆã‚ã‚Šï¼‰
            
            let beta = event.beta; 
            if (beta === null) return;

            // ç°¡æ˜“çš„ãªä»°è§’è¨ˆç®— (90åº¦=æ°´å¹³, è¦‹ä¸Šã’ã‚‹ã¨ãƒ—ãƒ©ã‚¹)
            // æ©Ÿç¨®ã‚„OSãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§æŒ™å‹•ãŒé€†è»¢ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚ã€ç¾åœ°ã§é•å’Œæ„Ÿã‚ã‚Œã°ã“ã“ã‚’ä¿®æ­£
            let elevation = 90 - beta;

            // è¡¨ç¤ºç”¨ã«ä¸¸ã‚ã‚‹
            currentBeta = elevation;
            document.getElementById('current-angle').textContent = elevation.toFixed(1) + "Â°";
        }

        function recordAngle(step) {
            if (step === 1) {
                angle1 = currentBeta;
                document.getElementById('val-1').textContent = `è¨˜éŒ²: ${angle1.toFixed(1)}Â°`;
                document.getElementById('step1').classList.add('step-done');
            } else if (step === 2) {
                angle2 = currentBeta;
                document.getElementById('val-2').textContent = `è¨˜éŒ²: ${angle2.toFixed(1)}Â°`;
                document.getElementById('step2').classList.add('step-done');
            } else if (step === 3) {
                angle3 = currentBeta;
                document.getElementById('val-3').textContent = `è¨˜éŒ²: ${angle3.toFixed(1)}Â°`;
                document.getElementById('step3').classList.add('step-done');
                calculateHeight();
            }
        }

        function calculateHeight() {
            const h = parseFloat(document.getElementById('pole-height').value);
            
            // è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
            const r1 = angle1 * (Math.PI / 180);
            const r2 = angle2 * (Math.PI / 180);
            const r3 = angle3 * (Math.PI / 180);

            // ã‚¿ãƒ³ã‚¸ã‚§ãƒ³ãƒˆè¨ˆç®—
            const t1 = Math.tan(r1);
            const t2 = Math.tan(r2);
            const t3 = Math.tan(r3);

            // åˆ†æ¯ãŒ0ã«ãªã‚‰ãªã„ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆã»ã¼åŒã˜è§’åº¦ã®å ´åˆãªã©ï¼‰
            if (Math.abs(t2 - t1) < 0.001) {
                alert("ã‚¨ãƒ©ãƒ¼: æ ¹å…ƒã¨ãƒãƒ¼ãƒ«ã®è§’åº¦å·®ãŒå°ã•ã™ãã¾ã™ã€‚ã‚‚ã†å°‘ã—æœ¨ã«è¿‘ã¥ãã‹ã€ãƒãƒ¼ãƒ«ãŒè¦‹ã‚„ã™ã„ä½ç½®ã§æ¸¬å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            // å…¬å¼: H = h * (tan3 - tan1) / (tan2 - tan1)
            const H = h * (t3 - t1) / (t2 - t1);
            
            // è·é›¢D = h / (tan2 - tan1)
            const D = h / (t2 - t1);

            document.getElementById('tree-height').textContent = H.toFixed(2);
            document.getElementById('tree-dist').textContent = D.toFixed(2);
            document.getElementById('result-area').style.display = 'block';
        }

        function resetMeasurement() {
            angle1 = null;
            angle2 = null;
            angle3 = null;
            document.getElementById('val-1').textContent = "";
            document.getElementById('val-2').textContent = "";
            document.getElementById('val-3').textContent = "";
            document.getElementById('step1').classList.remove('step-done');
            document.getElementById('step2').classList.remove('step-done');
            document.getElementById('step3').classList.remove('step-done');
            document.getElementById('result-area').style.display = 'none';
        }
    </script>
</body>
</html>