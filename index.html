<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¨¹é«˜æ¸¬å®š</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#28a745"> 
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #222;
            color: white;
        }

        /* èƒŒæ™¯ãƒ“ãƒ‡ã‚ªè¨­å®š */
        #camera-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            background-color: #000;
        }

        /* ç…§æº–ç·š */
        .crosshair {
            position: fixed;
            top: 50%; left: 0; width: 100%; height: 2px;
            background-color: rgba(255, 0, 0, 0.7);
            pointer-events: none;
        }
        .crosshair-v {
            position: fixed;
            top: 20%; left: 50%; width: 2px; height: 60%;
            background-color: rgba(255, 0, 0, 0.4);
            pointer-events: none;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
        #start-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        /* UIã‚³ãƒ³ãƒ†ãƒŠ */
        .ui-container {
            position: absolute;
            bottom: 0; left: 0; width: 100%;
            padding: 20px 20px 40px 20px;
            box-sizing: border-box;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0) 100%);
            display: none; /* ã‚¹ã‚¿ãƒ¼ãƒˆå¾Œã«è¡¨ç¤º */
            flex-direction: column;
            gap: 10px;
        }

        .top-info {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            text-align: center;
            pointer-events: none;
        }

        .debug-info {
            font-size: 0.7rem;
            color: #aaa;
            margin-bottom: 5px;
        }

        .angle-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 2px 2px 0px #000;
        }

        /* ãƒœã‚¿ãƒ³é¡ */
        button {
            padding: 15px;
            font-size: 1.2rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }

        .btn-primary { background-color: #007bff; width: 100%; margin-bottom: 10px; }
        .btn-action { background-color: #007bff; width: 100%; font-size: 1.3rem; padding: 18px; }
        .btn-start { background-color: #28a745; font-size: 1.5rem; padding: 20px 40px; border-radius: 50px; }
        
        .toggle-btn {
            background: rgba(255,255,255,0.2);
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: auto;
            margin-top: 5px;
        }

        /* çµæœè¡¨ç¤º */
        .result-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .result-box {
            background: white; color: #333;
            padding: 30px; border-radius: 15px;
            text-align: center; width: 85%; max-width: 400px;
        }
        .big-number { font-size: 3.5rem; font-weight: bold; color: #28a745; margin: 10px 0; }

        /* ã‚¹ãƒ†ãƒƒãƒ— */
        .step-dots { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .dot { width: 12px; height: 12px; background: #ccc; border-radius: 50%; }
        .dot.active { background: #007bff; transform: scale(1.3); }
        .dot.done { background: #28a745; }
        
        select { font-size: 1.2rem; padding: 8px; border-radius: 5px; }
        .control-panel { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; color: #333; text-align: center; }
    </style>
</head>
<body>

    <video id="camera-view" autoplay playsinline muted></video>

    <div class="crosshair"></div>
    <div class="crosshair-v"></div>

    <div id="start-overlay">
        <h1 style="margin-bottom:10px;">æ¨¹é«˜æ¸¬å®š v1.1</h1>
        <p style="font-size:0.9rem; color:#ccc; margin-bottom:30px;">
            ç«¯æœ«ã®ã‚«ãƒ¡ãƒ©ã¨è§’åº¦ã‚»ãƒ³ã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
            ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨±å¯ç”»é¢ãŒå‡ºãŸã‚‰ã€Œè¨±å¯ã€ã—ã¦ãã ã•ã„ã€‚<br>
            è…•ã‚’ã¾ã£ã™ãä¼¸ã°ã—åå­—ç·šã«åˆã‚ã›è§’åº¦ã‚’æ¸¬ã‚Šã¾ã™ã€‚
        </p>
        <button class="btn-start" onclick="startApp()">æ¸¬å®šã‚¹ã‚¿ãƒ¼ãƒˆ</button>
        <p id="error-log" style="color:red; margin-top:20px; font-size:0.8rem;"></p>
    </div>

    <div class="top-info" id="top-ui" style="display:none;">
        <div class="debug-info">Sensor Raw: <span id="raw-beta">--</span></div>
        <div class="angle-display" id="angle-val">--Â°</div>
        <button class="toggle-btn" onclick="toggleInvert()">ğŸ”„ è§’åº¦ã®ãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹ã‚’åè»¢</button>
    </div>

    <div class="ui-container" id="main-ui">
        <div class="control-panel">
            <div style="margin-bottom:15px;">
                <label>ãƒãƒ¼ãƒ«ç­‰ã®é«˜ã•: </label>
                <select id="pole-height"></select> m
            </div>
            
            <div class="step-dots">
                <div id="dot1" class="dot active"></div>
                <div id="dot2" class="dot"></div>
                <div id="dot3" class="dot"></div>
            </div>

            <div id="status-text" style="font-weight:bold; margin-bottom:10px; font-size:1.1rem;">â‘  ãƒãƒ¼ãƒ«æ ¹å…ƒ ã‚’ç‹™ã†</div>
            <button class="btn-action" id="btn-action" onclick="measureStep()">æ¸¬å®š</button>
        </div>
    </div>

    <div class="result-overlay" id="result-view">
        <div class="result-box">
            <div>æ¸¬å®šçµæœ</div>
            <div class="big-number"><span id="res-height">0.0</span> m</div>
            <div style="color:#666; margin-bottom:20px; font-size:0.9rem;">
                è·é›¢: <span id="res-dist">--</span> m / ãƒãƒ¼ãƒ«: <span id="res-pole">--</span> m
            </div>
            <button class="btn-primary" onclick="resetApp()" style="background:#6c757d;">ã‚‚ã†ä¸€åº¦æ¸¬ã‚‹</button>
        </div>
    </div>

    <script>
        // å¤‰æ•°
        let currentAngle = 0;
        let rawBeta = 0;
        let step = 1;
        let angles = { 1: null, 2: null, 3: null }; 
        let isInverted = false; // è§’åº¦åè»¢ãƒ•ãƒ©ã‚°

        // é«˜ã•ãƒªã‚¹ãƒˆç”Ÿæˆ
        const select = document.getElementById('pole-height');
        for(let i=1; i<=10; i++){
            let opt = document.createElement('option');
            opt.value = i; opt.text = i;
            if(i===2) opt.selected = true;
            select.appendChild(opt);
        }

        // ã‚¹ã‚¿ãƒ¼ãƒˆå‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³èµ·ç‚¹ï¼‰
        async function startApp() {
            const errLog = document.getElementById('error-log');
            errLog.textContent = "èµ·å‹•ä¸­...";

            try {
                // 1. iOSã®ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        throw new Error("ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ");
                    }
                }

                // 2. ã‚«ãƒ¡ãƒ©ã®èµ·å‹•
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                document.getElementById('camera-view').srcObject = stream;

                // 3. ã‚»ãƒ³ã‚µãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹
                window.addEventListener('deviceorientation', handleOrientation);

                // UIåˆ‡ã‚Šæ›¿ãˆ
                document.getElementById('start-overlay').style.display = 'none';
                document.getElementById('top-ui').style.display = 'block';
                document.getElementById('main-ui').style.display = 'flex';

            } catch (e) {
                console.error(e);
                errLog.textContent = "ã‚¨ãƒ©ãƒ¼: " + e.message;
                alert("èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message + "\nHTTPSæ¥ç¶šã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }

        function handleOrientation(event) {
            let beta = event.beta; 
            if (beta === null) return;
            
            rawBeta = beta;
            document.getElementById('raw-beta').textContent = beta.toFixed(1);

            // è§’åº¦è¨ˆç®—
            // æ¨™æº–: å‚ç›´(90) -> 0åº¦, è¦‹ä¸Šã’(90ã‚ˆã‚Šå°) -> ãƒ—ãƒ©ã‚¹
            // å¼: 90 - beta
            let tilt = 90 - beta;

            // ã‚‚ã—ã€Œåè»¢ã€ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ç¬¦å·ã‚’é€†ã«ã™ã‚‹
            if (isInverted) {
                tilt = -1 * tilt;
            }

            currentAngle = tilt;
            document.getElementById('angle-val').textContent = currentAngle.toFixed(1) + "Â°";
        }

        function toggleInvert() {
            isInverted = !isInverted;
            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°ãªã©ã¯çœç•¥ã€å³åº§ã«æ•°å€¤ãŒå¤‰ã‚ã‚‹
        }

        function measureStep() {
            angles[step] = currentAngle;

            if(step === 1) {
                // UIæ›´æ–°
                document.getElementById('dot1').classList.replace('active', 'done');
                document.getElementById('dot2').classList.add('active');
                document.getElementById('status-text').textContent = "â‘¡ ãƒãƒ¼ãƒ«ä¸Šç«¯ ã‚’ç‹™ã†";
                step++;
            } else if (step === 2) {
                document.getElementById('dot2').classList.replace('active', 'done');
                document.getElementById('dot3').classList.add('active');
                document.getElementById('status-text').textContent = "â‘¢ æœ¨ã®é ‚ç‚¹ ã‚’ç‹™ã†";
                document.getElementById('btn-action').textContent = "è¨ˆç®—å®Ÿè¡Œ";
                document.getElementById('btn-action').style.backgroundColor = "#28a745";
                step++;
            } else if (step === 3) {
                calcResult();
            }
        }

        function calcResult() {
            const h = parseFloat(document.getElementById('pole-height').value);
            
            const r1 = angles[1] * (Math.PI / 180);
            const r2 = angles[2] * (Math.PI / 180);
            const r3 = angles[3] * (Math.PI / 180);

            const t1 = Math.tan(r1);
            const t2 = Math.tan(r2);
            const t3 = Math.tan(r3);

            if (Math.abs(t2 - t1) < 0.0001) {
                alert("ã‚¨ãƒ©ãƒ¼: è§’åº¦å·®ãŒå°ã•ã™ãã¾ã™ã€‚ã‚‚ã†å°‘ã—æœ¨ã«è¿‘ã¥ãã‹ã€é›¢ã‚Œã¦ãã ã•ã„ã€‚");
                resetApp();
                return;
            }

            let H = h * (t3 - t1) / (t2 - t1);
            let D = h / (t2 - t1);

            // è² ã®å€¤ã«ãªã£ãŸå ´åˆã‚‚çµ¶å¯¾å€¤ã§è¡¨ç¤º
            document.getElementById('res-height').textContent = Math.abs(H).toFixed(1);
            document.getElementById('res-dist').textContent = Math.abs(D).toFixed(1);
            document.getElementById('res-pole').textContent = h;
            
            document.getElementById('result-view').style.display = 'flex';
        }

        function resetApp() {
            step = 1;
            angles = { 1: null, 2: null, 3: null };
            document.getElementById('result-view').style.display = 'none';
            
            document.getElementById('dot1').className = "dot active";
            document.getElementById('dot2').className = "dot";
            document.getElementById('dot3').className = "dot";
            
            document.getElementById('status-text').textContent = "â‘  ãƒãƒ¼ãƒ«æ ¹å…ƒ ã‚’ç‹™ã†";
            document.getElementById('btn-action').textContent = "æ¸¬å®š";
            document.getElementById('btn-action').style.backgroundColor = "#007bff";
        }
    </script>
    
    <script>
    // Service Workerã®ç™»éŒ²
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
            navigator.serviceWorker.register('./sw.js').then(function(registration) {
                console.log('ServiceWorker registration successful with scope: ', registration.scope);
            }, function(err) {
                console.log('ServiceWorker registration failed: ', err);
            });
        });
      }
     </script>
</body>
</html>


